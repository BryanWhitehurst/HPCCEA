---

- name: edit iptables
  hosts: management
  tasks:
  - name: find ip address of public interface
    set_fact:
      ext_ip: "{{ ansible_eno1.ipv4.address }}"
  - name: check ip
    debug:
      msg: "ip: {{ ext_ip }}"
  - name: install iptables
    yum:
      name:
        - iptables-services
      state: present
  - name: stop firewall
    ansible.builtin.systemd:
      name: firewalld
      state: stopped
      enabled: no
  - name: setup sysctl
    ansible.posix.sysctl:
      name: net.ipv4.ip_forward
      value: 1
      sysctl_set: yes
      state: present
  - name: delete autogenerated content
    lineinfile:
      path: /etc/sysconfig/iptables
      state: absent
      regexp: "."
  - name: edit /etc/sysconfig/iptables
    blockinfile:
      path: /etc/sysconfig/iptables
      block: |
        *nat
        -A POSTROUTING -s 192.168.95.0/24 -o eno1 -j SNAT --to-source {{ ext_ip }}
        COMMIT
  - name: delete begin marker
    lineinfile:
      path: /etc/sysconfig/iptables
      state: absent
      regexp: "# BEGIN ANSIBLE MANAGED BLOCK"
  - name: delete end marker
    lineinfile:
      path: /etc/sysconfig/iptables
      state: absent
      regexp: "# END ANSIBLE MANAGED BLOCK"
  - name: start iptables
    ansible.builtin.service:
      name: iptables
      state: started
      enabled: yes
...
